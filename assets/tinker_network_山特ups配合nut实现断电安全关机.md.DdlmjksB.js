import{_ as a,o as i,c as n,a2 as e}from"./chunks/framework.BGfUC0LL.js";const r=JSON.parse('{"title":"山特ups配合nut实现断电安全关机","description":"","frontmatter":{},"headers":[],"relativePath":"tinker/network/山特ups配合nut实现断电安全关机.md","filePath":"tinker/network/山特ups配合nut实现断电安全关机.md","lastUpdated":1770864474000}'),t={name:"tinker/network/山特ups配合nut实现断电安全关机.md"};function p(l,s,h,o,c,d){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="山特ups配合nut实现断电安全关机" tabindex="-1">山特ups配合nut实现断电安全关机 <a class="header-anchor" href="#山特ups配合nut实现断电安全关机" aria-label="Permalink to &quot;山特ups配合nut实现断电安全关机&quot;">​</a></h1><h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h2><p>搞了7*24小时服务器之后经历了两次突然断电，每次重启磁盘检查都要卡很久，夏天一到用电量骤升，市电断电和跳闸的几率都增加了。万一多来几次突然断电，磁盘阵列可能要挂了，更关键的是数据无价啊，ups还是少不了。</p><h2 id="选择" tabindex="-1">选择 <a class="header-anchor" href="#选择" aria-label="Permalink to &quot;选择&quot;">​</a></h2><p>因为不是成品nas系统，想实现自动关机得依靠linux上已有的软件。而我对<code>apcupsd</code> 这款软件有所耳闻，所以第一选择就去看了新款的<code>apc bk650m2-ch</code> ，快下单了才得知新款不支持apcupsd，然后就听网友的建议看了山特的<code>box600</code>和<code>box850</code> ，山特这个型号有两排插座，一排防雷+不断电，一排是防雷，还省了了插排钱，自带的usb通讯端口可以通过<code>nut</code> 软件进行管理，实现自动关机以及自定义脚本执行等功能，虽然电池容量小了点，但是能省就省吧，最后下单了box600。</p><h2 id="nut安装及配置" tabindex="-1">nut安装及配置 <a class="header-anchor" href="#nut安装及配置" aria-label="Permalink to &quot;nut安装及配置&quot;">​</a></h2><p>ups机器本身没什么可讲的，把附带的rj45接ups，usb线接主机，再把主机电源插在ups的不断电插口上，接着给ups通电即可。主要介绍下nut的使用和配置。</p><h3 id="安装nut" tabindex="-1">安装nut <a class="header-anchor" href="#安装nut" aria-label="Permalink to &quot;安装nut&quot;">​</a></h3><p><code>apt install nut</code></p><h3 id="配置驱动" tabindex="-1">配置驱动 <a class="header-anchor" href="#配置驱动" aria-label="Permalink to &quot;配置驱动&quot;">​</a></h3><p>首先可以用<code>lsusb</code>命令查看是否接入了ups，能看到ups即可</p><p><img src="https://storyxc.com/images/blog/image-20220524232436626.png" alt="image-20220524232436626"></p><p>然后编辑ups配置文件<code>vim /etc/nut/ups.conf</code>,增加配置如下</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>maxretry = 3</span></span>
<span class="line"><span>[santak]</span></span>
<span class="line"><span>        driver = usbhid-ups</span></span>
<span class="line"><span>        port = auto</span></span>
<span class="line"><span>        desc = &quot;my ups&quot;</span></span></code></pre></div><p>santak是ups的设备名，可以自定义，后续有些命令这个设备名还会用到</p><h3 id="配置nut服务" tabindex="-1">配置nut服务 <a class="header-anchor" href="#配置nut服务" aria-label="Permalink to &quot;配置nut服务&quot;">​</a></h3><h4 id="新建ups用户" tabindex="-1">新建ups用户 <a class="header-anchor" href="#新建ups用户" aria-label="Permalink to &quot;新建ups用户&quot;">​</a></h4><p><code>vim /etc/nut/upsd.users</code>新增配置</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>[ups]</span></span>
<span class="line"><span>        password = xxx</span></span>
<span class="line"><span>        upsmon master</span></span></code></pre></div><p><code>ups</code>为用户名，<code>xxx</code>为密码，<code>upsmon master</code>为运行模式</p><h4 id="配置权限" tabindex="-1">配置权限 <a class="header-anchor" href="#配置权限" aria-label="Permalink to &quot;配置权限&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root:nut</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsd.conf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsd.users</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0640</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsd.conf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsd.users</span></span></code></pre></div><h4 id="启动nut服务" tabindex="-1">启动nut服务 <a class="header-anchor" href="#启动nut服务" aria-label="Permalink to &quot;启动nut服务&quot;">​</a></h4><p><code>vim /etc/nut/nut.conf</code>修改模式为单机</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>MODE=standalone</span></span></code></pre></div><p>启动upsd服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/sbin/upsd</span></span></code></pre></div><h4 id="查看ups信息" tabindex="-1">查看ups信息 <a class="header-anchor" href="#查看ups信息" aria-label="Permalink to &quot;查看ups信息&quot;">​</a></h4><p>查看全部</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/upsc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> santak@localhost</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 这里的santak就是上面的设备名</span></span></code></pre></div><p>查看某个信息在后面接信息类别就行，例如查看电量</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/upsc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> santak@127.0.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> battery.charge</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Init</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SSL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> without</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> database</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">100</span></span></code></pre></div><h2 id="设置自动关机" tabindex="-1">设置自动关机 <a class="header-anchor" href="#设置自动关机" aria-label="Permalink to &quot;设置自动关机&quot;">​</a></h2><p>nut服务会在UPS发送<code>LOWBATT</code>时通知机器关机，触发时机默认为ups电量剩余<code>20%</code> 。我们需要添加upsmon配置<code>vim /etc/nut/upsmon.conf</code></p><p>在<code>MONITOR</code>监视器部分添加配置</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>MONITOR santak@localhost 1 ups xxx master</span></span>
<span class="line"><span></span></span>
<span class="line"><span># MONITOR 设备名@ip 1 用户名 密码 节点</span></span></code></pre></div><p>授权</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root:nut</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsmon.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0640</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nut/upsmon.conf</span></span></code></pre></div><p>启动upsmon</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/sbin/upsmon</span></span></code></pre></div><h2 id="自定义脚本" tabindex="-1">自定义脚本 <a class="header-anchor" href="#自定义脚本" aria-label="Permalink to &quot;自定义脚本&quot;">​</a></h2><p>实际上配置完上面的内容已经可以实现断电时安全关机了，但喜欢折腾的还可以自定义触发事件的脚本</p><h3 id="修改upsmon配置" tabindex="-1">修改upsmon配置 <a class="header-anchor" href="#修改upsmon配置" aria-label="Permalink to &quot;修改upsmon配置&quot;">​</a></h3><p><code>vim /etc/nut/upsmon.conf</code>添加内容</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>NOTIFYCMD /sbin/upssched</span></span></code></pre></div><p>这个配置的作用是发生事件是运行<code>upssched</code>程序</p><p>设置触发条件,三个动作分别是记录日志+通知所有用户发生了事件+执行notifycmd，也就是<code>/sbin/upssched</code></p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>NOTIFYFLAG ONBATT SYSLOG+WALL+EXEC</span></span></code></pre></div><h3 id="配置upssched" tabindex="-1">配置upssched <a class="header-anchor" href="#配置upssched" aria-label="Permalink to &quot;配置upssched&quot;">​</a></h3><p><code>vim /etc/nut/upssched.conf</code>编辑内容</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>CMDSCRIPT /usr/local/bin/upssched</span></span>
<span class="line"><span>PIPEFN /var/run/nut/upssched/upssched.pipe</span></span>
<span class="line"><span>LOCKFN /var/run/nut/upssched/upssched.lock</span></span>
<span class="line"><span>AT ONBATT * START-TIMER power-off 10</span></span>
<span class="line"><span>AT ONLINE * CANCEL-TIMER power-off</span></span></code></pre></div><p>这段配置通过CMDSCRIPT指定了发生事件时需要执行的脚本，这个脚本可以根据需求自定义，在断电时(ONBATT/电池供电) 会启动一个10秒的timer，之后会执行power-off事件，这里涉及的文件nut用户都需要配置权限</p><h3 id="编写脚本" tabindex="-1">编写脚本 <a class="header-anchor" href="#编写脚本" aria-label="Permalink to &quot;编写脚本&quot;">​</a></h3><p>这个可以自定义，例如发邮件等操作，这里展示最基本的脚本格式，例如power-off事件发生时，将<code>断电了</code> 信息写入指定文件，还可以调用ups的指令<code>/sbin/upsmon -c fsd</code>执行立刻关机操作 (FSD = &quot;Forced Shutdown&quot;)</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#! /bin/sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> $1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  power-off</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;$(date +\\%Y-\\%m-\\%d\\ \\%H:\\%M:\\%S) - 断电了 &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/nut/nut.log</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #/sbin/upsmon -c fsd #立即通知关机</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  *)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    logger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upssched</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Unrecognized command: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span></code></pre></div>`,55)])])}const k=a(t,[["render",p]]);export{r as __pageData,k as default};
